# External Parameter Processing for Hurricane Segments

## Overview

The `run_extpar_levante.bash` script processes external parameters for hurricane-centric grids using ICON ExtPar tools. It generates topography, land use, soil properties, and other surface parameters required for hurricane-focused ICON simulations on segment-specific nested grids.

## Purpose

This script addresses the specific requirements of hurricane modeling by:

- Processing external parameters for hurricane-centric nested grids
- Generating topography data with sub-grid scale orography parameterization
- Creating land use classifications optimized for hurricane environments
- Processing soil properties, albedo, and vegetation parameters
- Handling freshwater lake data and aerosol optical thickness
- Ensuring consistency across all nested domains

## Prerequisites

### System Requirements
- Linux environment with SLURM workload manager
- Access to Levante supercomputer (or similar HPC system)
- Python 3.6+ with scientific packages
- CDO (Climate Data Operators)
- ICON ExtPar tools and libraries

### Required Files
- Hurricane-centric grid files (generated by `generate_grid_for_hurricane_segments.sh`)
- ExtPar input datasets (ERA5, GLOBCOVER, soil data, etc.)
- Configuration file (`hurricane_config.toml`)

### Required Input Datasets
- **Topography**: GLOBE topography tiles (A10-P10)
- **Land Use**: GLOBCOVER and GLCC datasets
- **Soil**: FAO soil classification data
- **ERA5**: Orography, temperature, SST, and snow depth
- **Albedo**: Surface albedo datasets
- **NDVI**: Vegetation index data
- **Aerosols**: MACC aerosol optical thickness
- **Lakes**: GLDB lake depth data

## Configuration

The script reads configuration from `../../config/hurricane_config.toml`. Key configuration sections:

### Project Settings
```toml
[project]
name = "paulette-segments"           # Project name for grid directories
width_config = "width20km"           # Grid configuration identifier
```

### Paths
```toml
[paths]
extpar_input_dir = "/work/pd1167/extpar-input-data"  # ExtPar input datasets
extpar_dir = "/work/bb1376/tools/extpar"             # ExtPar tool installation
output_base = "/path/to/output"                      # Output directory base
```

### Simulation Parameters
```toml
[simulation]
expname = "ifces2-atlanXL-20200907-exp021"  # Experiment name
nests = 3                                    # Number of nested domains
```

## Usage

### Basic Usage
```bash
cd /path/to/hurricane-centric-setup-tools/scripts/grid-extpar
sbatch run_extpar_levante.bash [segment_number]
```

### Parameters
- `segment_number`: Integer specifying which hurricane segment to process (e.g., 1, 2, 3, ...)

### Example
```bash
# Process external parameters for segment 5
sbatch run_extpar_levante.bash 5
```

## Workflow

The script executes the following processing steps for each nested domain:

### 1. Environment Setup
- Loads required modules (Python, CDO)
- Sets up ExtPar library paths and working directories
- Creates segment-specific output directories

### 2. Configuration Generation
- Creates Python namelists for input data specifications
- Generates Fortran namelists for each parameter type
- Sets up grid-specific input files

### 3. Fortran Processing Chain
Processes the following parameters using ExtPar Fortran binaries:
- **Topography** (`extpar_topo_to_buffer.exe`): Sub-grid scale orography
- **Land Use** (`extpar_landuse_to_buffer.exe`): GLOBCOVER/GLCC classification
- **Lakes** (`extpar_flake_to_buffer.exe`): Freshwater lake parameters
- **Soil** (`extpar_soil_to_buffer.exe`): Soil type and properties
- **Aerosols** (`extpar_aot_to_buffer.exe`): Aerosol optical thickness

### 4. Python Processing Chain
Processes the following parameters using ExtPar Python scripts:
- **ERA5** (`extpar_era_to_buffer.py`): ERA5-based surface fields
- **Albedo** (`extpar_alb_to_buffer.py`): Surface albedo
- **NDVI** (`extpar_ndvi_to_buffer.py`): Vegetation index
- **Emissivity** (`extpar_emiss_to_buffer.py`): Surface emissivity
- **Climate** (`extpar_cru_to_buffer.py`): Climatological temperature

### 5. Consistency Check
- Runs final consistency check (`extpar_consistency_check.exe`)
- Combines all parameters into final ExtPar files
- Validates output for completeness and consistency

## Output Files

### ExtPar Files
```
output_base/project_name/seg{N}_{width_config}/
├── extpar_paulette-seg{N}_dom1_tiles.nc    # First nested domain ExtPar
├── extpar_paulette-seg{N}_dom2_tiles.nc    # Second nested domain ExtPar
└── extpar_paulette-seg{N}_dom3_tiles.nc    # Third nested domain ExtPar
```

### Log Files
```
output_base/project_name/seg{N}_{width_config}/
├── paulette-seg{N}_dom1.log                # Processing log for domain 1
├── paulette-seg{N}_dom2.log                # Processing log for domain 2
└── paulette-seg{N}_dom3.log                # Processing log for domain 3
```

### Intermediate Files
- Buffer files for each parameter type (e.g., `topography_buffer.nc`)
- Individual parameter output files
- Processing namelists and configuration files

## SLURM Job Configuration

The script is configured for the Levante supercomputer with the following resource requirements:

```bash
#SBATCH --account=bb1376
#SBATCH --job-name=extpar
#SBATCH --partition=compute
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=4
#SBATCH --cpus-per-task=32
#SBATCH --exclusive
#SBATCH --time=00:20:00
```

### Resource Usage
- **Cores**: 4 tasks × 32 CPUs = 128 total CPUs
- **Memory**: Exclusive node access
- **Runtime**: Up to 20 minutes
- **Working Directory**: `/scratch/b/b380352/icontools`

## Processing Details

### Topography Processing
- Uses GLOBE 30-arcsec elevation data
- Calculates sub-grid scale orography parameters
- Generates slope statistics for turbulence parameterization
- Handles coastline smoothing and filtering

### Land Use Processing
- Processes GLOBCOVER 300m resolution data
- Converts to ICON land use classes
- Handles urban areas and water body classification
- Generates tile-based land use fractions

### Soil Processing
- Uses FAO soil classification data
- Processes soil type and hydraulic properties
- Handles deep soil layers if configured
- Ensures consistency with land-sea mask

## Error Handling

### Common Issues

1. **Missing Input Data**
   - Error: "Input file not found"
   - Solution: Verify ExtPar input datasets are available in `extpar_input_dir`

2. **Grid File Not Found**
   - Error: "ICON grid file not found"
   - Solution: Ensure grid generation completed successfully first

3. **ExtPar Tool Errors**
   - Error: ExtPar binary execution fails
   - Solution: Check ExtPar installation and library paths

4. **Memory Issues**
   - Error: Out of memory during processing
   - Solution: Increase memory allocation or reduce domain size

5. **Inconsistent Parameters**
   - Error: Consistency check fails
   - Solution: Review log files for parameter conflicts

### Debugging

Enable detailed output by:
```bash
# Check individual log files
cat extpar_topo_to_buffer.log
cat extpar_landuse_to_buffer.log

# Monitor resource usage
squeue -u $USER
sacct -j [job_id] --format=JobID,JobName,MaxRSS,Elapsed
```

## Performance Considerations

- Processing time scales with grid resolution and domain size
- High-resolution nested grids require more memory and processing time
- Parallel processing across multiple domains
- I/O intensive due to large input datasets

## Integration

This script is part of the hurricane-centric preprocessing chain:

1. Grid Generation (`generate_grid_for_hurricane_segments.sh`)
2. **External Parameter Processing** ← (This script)
3. Initial Conditions (`icon2icon_offline_lam_ini.bash`)
4. Boundary Conditions (`icon2icon_offline_lam_lbc.bash`)

## Dependencies

### Configuration Files
- `toml_reader.sh`: Configuration file parser
- `hurricane_config.toml`: Central configuration file

### External Tools
- ExtPar Fortran binaries (in `${extpar_dir}/bin/`)
- ExtPar Python scripts (in `${extpar_dir}/python/`)
- CDO and NetCDF libraries
- SLURM workload manager

### Input Datasets
All datasets must be available in `${extpar_input_dir}/`:
- `era/`: ERA5 reanalysis data
- `topo/globe/`: GLOBE topography tiles
- `landuse/`: GLOBCOVER and GLCC datasets
- `soil/`: FAO soil classification
- `albedo/`: Surface albedo data
- `ndvi/`: NDVI vegetation data
- `aerosols/`: MACC aerosol data
- `flake/`: Lake depth data

## Data Requirements

### Disk Space
- Input datasets: ~100-500 GB (depending on coverage)
- Output ExtPar files: ~1-10 GB per domain
- Temporary files: ~5-20 GB during processing

### Processing Time
- Typical runtime: 10-20 minutes per segment
- Scales with number of nested domains
- High-resolution domains require longer processing

## Troubleshooting

### Log Files
Check SLURM and ExtPar log files for detailed error messages:
```bash
# View job output
cat slurm-{job_id}.out

# Check ExtPar processing logs
cat paulette-seg{N}_dom{M}.log

# Monitor individual tool logs
ls -la *.log
```

### Validation
Verify ExtPar file integrity:
```bash
# Check NetCDF structure
ncdump -h extpar_paulette-seg{N}_dom{M}_tiles.nc

# Validate with CDO
cdo info extpar_paulette-seg{N}_dom{M}_tiles.nc

# Check for required variables
ncdump -v topography_c extpar_file.nc | head -20
```

### Common Solutions

1. **Restart from checkpoint**: Delete problematic buffer files and restart
2. **Check input data availability**: Verify all required datasets exist
3. **Monitor resource usage**: Ensure adequate memory and disk space
4. **Validate grid files**: Confirm input grids are properly formatted

## Support

For issues or questions:
- Check processing log files for specific error messages
- Verify ExtPar input dataset availability and format
- Ensure sufficient computational resources
- Contact: Fabian Senf - senf@tropos.de

## References

- ICON ExtPar User Guide
- ICON Grid Generation Documentation
- ExtPar Dataset Documentation